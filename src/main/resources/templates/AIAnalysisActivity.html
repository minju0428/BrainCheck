<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBTI 분석 결과 상세</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 기존 CSS 스타일 유지 */
        :root {
            --primary-purple: #a238ff;
            --secondary-pink: #ff3ca6;
            --purple-light: #f3e8ff;
            --blue-main: #3b82f6;

            /* 배경 그라데이션 보라색 계열 */
            --bg-gradient: radial-gradient(circle at top left, #e0f2fe 0%, #f3e8ff 50%, #ffffff 100%);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
        }

        .result-box {
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .bar-container {
            display: flex;
            align-items: center;
            height: 25px;
            border-radius: 9999px;
            overflow: hidden;
            background-color: var(--purple-light);
        }

        .bar-segment {
            height: 100%;
            background-color: var(--primary-purple);
            transition: width 0.5s ease-in-out;
            white-space: nowrap;
            padding-left: 0.5rem;
            display: flex;
            align-items: center;
            color: white;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .bar-reverse-segment {
            height: 100%;
            transition: width 0.5s ease-in-out;
            white-space: nowrap;
            padding-right: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            color: var(--primary-purple);
            font-size: 0.875rem;
            font-weight: 600;
        }

        .dimension-card {
            padding: 1.25rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }

        .dimension-icon {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .persuade-button {
            background: linear-gradient(135deg, #ef4444, #f472b6);
            transition: all 0.3s ease;
        }
        .persuade-button:hover {
            background: linear-gradient(135deg, #dc2626, #ec4899);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
        }
    </style>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="flex justify-center py-10 md:py-16 px-4">

<div class="max-w-xl w-full space-y-8">

    <div style="display: none;">
        <input type="hidden" id="hiddenTitle" th:value="${title ?: ''}" />
        <input type="hidden" id="hiddenCharacterName" th:value="${characterName ?: ''}" />
        <input type="hidden" id="hiddenCategory" th:value="${category ?: ''}" />

        <input type="hidden" id="hiddenPredictedMbti1" th:value="${fullMbti ?: ''}" />
        <input type="hidden" id="hiddenPredictedMbti2" th:value="${aiThing ?: ''}" />

        <input type="hidden" id="hiddenValueE" th:value="${valueE ?: '0'}" />
        <input type="hidden" id="hiddenValueI" th:value="${valueI ?: '0'}" />
        <input type="hidden" id="hiddenValueS" th:value="${valueS ?: '0'}" />
        <input type="hidden" id="hiddenValueN" th:value="${valueN ?: '0'}" />
        <input type="hidden" id="hiddenValueT" th:value="${valueT ?: '0'}" />
        <input type="hidden" id="hiddenValueF" th:value="${valueF ?: '0'}" />
        <input type="hidden" id="hiddenValueJ" th:value="${valueJ ?: '0'}" />
        <input type="hidden" id="hiddenValueP" th:value="${valueP ?: '0'}" />

        <input type="hidden" id="hiddenAiEi" th:value="${aiEi ?: ''}" />
        <input type="hidden" id="hiddenAiSn" th:value="${aiSn ?: ''}" />
        <input type="hidden" id="hiddenAiTf" th:value="${aiTf ?: ''}" />
        <input type="hidden" id="hiddenAiJp" th:value="${aiJp ?: ''}" />

        <input type="hidden" id="hiddenUserEi" th:value="${ei ?: ''}" />
        <input type="hidden" id="hiddenUserSn" th:value="${sn ?: ''}" />
        <input type="hidden" id="hiddenUserTf" th:value="${tf ?: ''}" />
        <input type="hidden" id="hiddenUserJp" th:value="${jp ?: ''}" />


        <input type="hidden" id="hiddenIsMatch" th:value="${isMbtiMatch ?: 'false'}" />
    </div>

    <div class="text-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">
            ${characterName}
        </h1>
        <p class="text-gray-500 text-lg">
            ${title}
        </p>
    </div>

    <div class="grid grid-cols-2 gap-4">

        <div class="result-box bg-purple-50 space-y-3">
            <div class="flex items-center text-purple-700">
                <i data-lucide="user" class="w-5 h-5 mr-2"></i>
                <span class="font-semibold">당신이 예측한 MBTI</span>
            </div>
            <div class="p-3 bg-white rounded-lg w-fit text-xl font-bold text-purple-600 shadow-md">
                ${fullMbti}
            </div>
        </div>

        <div class="result-box bg-blue-50 space-y-3">
            <div class="flex items-center text-blue-700">
                <i data-lucide="brain" class="w-5 h-5 mr-2"></i>
                <span class="font-semibold">AI가 분석한 MBTI</span>
            </div>
            <div class="p-3 bg-white rounded-lg w-fit text-xl font-bold text-blue-600 shadow-md">
                ${aiThing}
            </div>
        </div>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-lg space-y-5">
        <h2 class="text-lg font-bold text-gray-800 flex items-center">
            <i data-lucide="activity" class="w-5 h-5 mr-2 text-blue-500"></i> AI 분석 상세 지표
        </h2>

        <div>
            <div class="flex justify-between text-sm font-semibold text-gray-700 mb-1">
                <span>E 외향</span>
                <span>에너지의 방향성</span>
                <span>내향 I</span>
            </div>
            <div class="bar-container">
                <div class="bar-segment" style="width: ${valueE}%;"> ${valueE}%</div>
                <div class="bar-reverse-segment" style="width: ${valueI}%;"> ${valueI}%</div>
            </div>
        </div>

        <div>
            <div class="flex justify-between text-sm font-semibold text-gray-700 mb-1">
                <span>S 감각</span>
                <span>인식 기능</span>
                <span>직관 N</span>
            </div>
            <div class="bar-container">
                <div class="bar-segment" style="width: ${valueS}%;"> ${valueS}%</div>
                <div class="bar-reverse-segment" style="width: ${valueN}%;"> ${valueN}%</div>
            </div>
        </div>

        <div>
            <div class="flex justify-between text-sm font-semibold text-gray-700 mb-1">
                <span>T 사고</span>
                <span>판단 기능</span>
                <span>감정 F</span>
            </div>
            <div class="bar-container">
                <div class="bar-segment" style="width: ${valueT}%;"> ${valueT}%</div>
                <div class="bar-reverse-segment" style="width: ${valueF}%;"> ${valueF}%</div>
            </div>
        </div>

        <div>
            <div class="flex justify-between text-sm font-semibold text-gray-700 mb-1">
                <span>J 판단</span>
                <span>생활 양식</span>
                <span>인식 P</span>
            </div>
            <div class="bar-container">
                <div class="bar-segment" style="width: ${valueJ}%;"> ${valueJ}%</div>
                <div class="bar-reverse-segment" style="width: ${valueP}%;"> ${valueP}%</div>
            </div>
        </div>

    </div>

    <div id="mbti-message-container">
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
    </div>

    <div class="bg-white p-5 rounded-xl shadow-lg" id="persuade-section">
        <h3 class="text-base font-bold text-gray-800 mb-4">설득 대상 차원</h3>
        <div class="flex flex-wrap gap-3">
        </div>
    </div>

    <div class="flex justify-center pt-4">
        <button id="persuade-button" class="persuade-button w-full max-w-md py-4 rounded-full text-white font-bold text-lg shadow-lg flex items-center justify-center gap-3">
            <i data-lucide="swords" class="w-6 h-6"></i>
            <span>설득 대결 시작하기</span>
        </button>
    </div>


</div>

<script>
    // Lucide Icons 초기화 (아이콘 렌더링)
    lucide.createIcons();

    // --------------------------------------------------
    // 0. 숨겨진 필드에서 값 읽어오기
    // --------------------------------------------------
    const hiddenTitle = document.getElementById('hiddenTitle');
    const hiddenCharacterName = document.getElementById('hiddenCharacterName');
    const hiddenCategory = document.getElementById('hiddenCategory');
    const hiddenPredictedMbti1 = document.getElementById('hiddenPredictedMbti1');
    const hiddenPredictedMbti2 = document.getElementById('hiddenPredictedMbti2');
    const hiddenValueE = document.getElementById('hiddenValueE');
    const hiddenValueI = document.getElementById('hiddenValueI');
    const hiddenValueS = document.getElementById('hiddenValueS');
    const hiddenValueN = document.getElementById('hiddenValueN');
    const hiddenValueT = document.getElementById('hiddenValueT');
    const hiddenValueF = document.getElementById('hiddenValueF');
    const hiddenValueJ = document.getElementById('hiddenValueJ');
    const hiddenValueP = document.getElementById('hiddenValueP');

    // AI 도출한 MBTI 개별 지표
    const hiddenAiEi = document.getElementById('hiddenAiEi');
    const hiddenAiSn = document.getElementById('hiddenAiSn');
    const hiddenAiTf = document.getElementById('hiddenAiTf');
    const hiddenAiJp = document.getElementById('hiddenAiJp');

    // 사용자 선택한 MBTI 개별 지표
    const hiddenUserEi = document.getElementById('hiddenUserEi');
    const hiddenUserSn = document.getElementById('hiddenUserSn');
    const hiddenUserTf = document.getElementById('hiddenUserTf');
    const hiddenUserJp = document.getElementById('hiddenUserJp');

    // mbti 분석 결과가 일치하는지 판별
    const hiddenIsMatch = document.getElementById('hiddenIsMatch');
    const isMbtiMatch = hiddenIsMatch ? (hiddenIsMatch.value === 'true') : false;


    // --------------------------------------------------
    // 1. 전체 일치/불일치 메시지 렌더링
    // --------------------------------------------------
    const container = document.getElementById('mbti-message-container');

    if (isMbtiMatch) {
        // 결과 일치 UI (초록색 뉘앙스)
        container.innerHTML = `
            <div class="bg-green-50 border border-green-200 rounded-xl p-4 flex items-start gap-3">
                <div class="flex-shrink-0">
                    <i data-lucide="check-circle" class="w-6 h-6 text-green-500"></i>
                </div>
                <p class="text-sm text-green-800 flex-1 leading-relaxed">
                    <span class="font-semibold">분석이 일치합니다!</span> 당신이 예측한 MBTI와 AI의 분석 결과가 완벽하게 일치했습니다.
                </p>
            </div>
        `;
    } else {
        // 결과 불일치 UI (주황색 경고 UI)
        container.innerHTML = `
            <div class="bg-orange-50 border border-orange-200 rounded-xl p-4 flex items-start gap-3">
                <div class="flex-shrink-0">
                    <i data-lucide="alert-triangle" class="w-6 h-6 text-orange-500"></i>
                </div>
                <p class="text-sm text-orange-800 flex-1 leading-relaxed">
                    <span class="font-semibold">분석 차이가 발견되었습니다.</span> AI와 2개의 출처가 서로 다른 분석 결과를 도출했습니다. 작품의 근거와 논리로 AI를 설득해주세요!
                </p>
            </div>
        `;
    }


    // --------------------------------------------------
    // 2. 개별 지표 일치/불일치 카드 동적 렌더링 로직
    // --------------------------------------------------

    const dimensions = [
        {
            name: "에너지 방향",
            user: hiddenUserEi.value,
            ai: hiddenAiEi.value,
            options: ['E', 'I'],
        },
        {
            name: "인식 기능",
            user: hiddenUserSn.value,
            ai: hiddenAiSn.value,
            options: ['S', 'N'],
        },
        {
            name: "판단 기능",
            user: hiddenUserTf.value,
            ai: hiddenAiTf.value,
            options: ['T', 'F'],
        },
        {
            name: "생활 양식",
            user: hiddenUserJp.value,
            ai: hiddenAiJp.value,
            options: ['J', 'P'],
        }
    ];

    const gridContainer = document.querySelector('.grid.grid-cols-2.md\:grid-cols-4.gap-3');
    gridContainer.innerHTML = ''; // 기존 정적 카드 내용 초기화

    let nonMatchDimensions = []; // 불일치하는 차원을 저장할 배열

    dimensions.forEach(dim => {
        // user와 ai 값이 같고 비어있지 않을 때 일치로 판단
        const isMatch = dim.user === dim.ai && dim.user !== '';

        // Tailwind CSS 클래스 조건부 설정
        const matchClass = isMatch ? 'bg-green-50' : 'bg-orange-50';
        const userIconColor = isMatch ? 'bg-green-500' : 'bg-purple-500';
        const aiIconColor = isMatch ? 'bg-green-500' : 'bg-blue-500';
        const centerIconColor = isMatch ? 'bg-green-500' : 'bg-red-500';
        const textColor = isMatch ? 'text-green-600' : 'text-red-600';
        const statusText = isMatch ? '일치' : '불일치';
        const centerIcon = isMatch
            ? `<i data-lucide="check" class="w-5 h-5"></i>`
            : `<i data-lucide="x" class="w-5 h-5"></i>`;

        // 불일치하는 차원만 설득 대상 목록에 추가
        if (!isMatch) {
            nonMatchDimensions.push(`${dim.options[0]}/${dim.options[1]} (${dim.name})`);
        }


        const cardHtml = `
            <div class="dimension-card ${matchClass}">
                <p class="text-sm font-bold text-gray-800 text-left w-full">${dim.name}</p>
                <div class="flex items-center justify-center gap-2">
                    <div class="dimension-icon ${userIconColor} text-white">${dim.user || '?'}</div>
                    <div class="dimension-icon ${centerIconColor} text-white">
                        ${centerIcon}
                    </div>
                    <div class="dimension-icon ${aiIconColor} text-white">${dim.ai || '?'}</div>
                </div>
                <span class="text-sm font-semibold ${textColor}">${statusText}</span>
            </div>
        `;

        gridContainer.innerHTML += cardHtml;
    });

    // --------------------------------------------------
    // 3. 설득 대상 차원 버튼 동적 렌더링 및 섹션 표시/숨김
    // --------------------------------------------------

    const persuadeTargetContainer = document.querySelector('#persuade-section .flex.flex-wrap.gap-3');
    const persuadeSection = document.getElementById('persuade-section');
    persuadeTargetContainer.innerHTML = ''; // 기존 버튼 초기화

    if (nonMatchDimensions.length > 0) {
        // 불일치하는 지표가 있을 경우 버튼을 렌더링하고 섹션을 표시
        nonMatchDimensions.forEach(dimText => {
            const buttonHtml = `
                <button class="px-4 py-2 bg-orange-100 hover:bg-orange-200 text-orange-700 font-semibold rounded-lg transition-colors text-sm">
                    ${dimText}
                </button>
            `;
            persuadeTargetContainer.innerHTML += buttonHtml;
        });
        persuadeSection.style.display = 'block';

    } else {
        // 모든 지표가 일치할 경우 버튼 섹션을 숨김
        persuadeSection.style.display = 'none';
    }


    // 새로 추가된 아이콘을 포함하여 Lucide 아이콘 다시 생성
    lucide.createIcons();


    // --------------------------------------------------
    // 4. 설득 대결 시작하기 버튼 클릭 이벤트 (데이터 전달 로직)
    // --------------------------------------------------
    const persuadeButton = document.getElementById('persuade-button');
    persuadeButton.addEventListener('click', () => {
        // 모든 데이터를 쿼리 파라미터로 조합하여 다음 페이지로 전달
        const nextUrl = `/persuade/start?` +
            `title=${encodeURIComponent(hiddenTitle.value)}&` +
            `characterName=${encodeURIComponent(hiddenCharacterName.value)}&` +
            `category=${encodeURIComponent(hiddenCategory.value)}&` +
            //사용자가 생각하는 mbti
            `predictedMbti1=${encodeURIComponent(hiddenPredictedMbti1.value)}&` +
            //ai가 생각하는 mbti
            `predictedMbti2=${encodeURIComponent(hiddenPredictedMbti2.value)}&` +
            `aiEi=${hiddenAiEi.value}&` +
            `aiSn=${hiddenAiSn.value}&` +
            `aiTf=${hiddenAiTf.value}&` +
            `aiJp=${hiddenAiJp.value}&` +
            `valueE=${hiddenValueE.value}&valueI=${hiddenValueI.value}&` +
            `valueS=${hiddenValueS.value}&valueN=${hiddenValueN.value}&` +
            `valueT=${hiddenValueT.value}&valueF=${hiddenValueF.value}&` +
            `valueJ=${hiddenValueJ.value}&valueP=${hiddenValueP.value}&`;

        console.log("다음 URL로 이동:", nextUrl);
        window.location.href = nextUrl;
    });

</script>
</body>
</html>
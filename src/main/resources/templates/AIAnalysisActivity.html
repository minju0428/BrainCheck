<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${title} + ' MBTI ë¶„ì„ ê²°ê³¼ ìƒì„¸'">MBTI ë¶„ì„ ê²°ê³¼ ìƒì„¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ê¸°ì¡´ CSS ìŠ¤íƒ€ì¼ ìœ ì§€ */
        :root {
            --primary-purple: #a238ff;
            --secondary-pink: #ff3ca6;
            --purple-light: #f3e8ff;
            --blue-main: #3b82f6; /* ë°” ì°¨íŠ¸ ë©”ì¸ ìƒ‰ìƒ */
            --bg-gradient: radial-gradient(circle at top left, #e0f2fe 0%, #f3e8ff 50%, #ffffff 100%);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
        }

        .result-box {
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        /*  */
        /* === ë¶„ì„ ëŒ€ìƒ ì •ë³´ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ === */
        .info-box-header {
            color: var(--primary-purple); /* ë³´ë¼ìƒ‰ í—¤ë” í…ìŠ¤íŠ¸ */
        }
        .info-detail {
            margin-left: 1.5rem; /* ë“¤ì—¬ì“°ê¸° */
        }
        /* === End of Bar Chart Style === */

        /* ... (ë‚˜ë¨¸ì§€ ìŠ¤íƒ€ì¼ ì½”ë“œëŠ” ìƒëµ) ... */
        .bar-chart-item { margin-bottom: 1rem; }
        .bar-container-new {
            display: flex; height: 35px; border-radius: 9999px; overflow: hidden;
            background-color: #e5e7eb; margin-top: 5px; position: relative;
        }
        .bar-label-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; justify-content: center; align-items: center;
            font-size: 0.875rem; font-weight: 600; color: #1f2937;
        }
        .bar-segment-left { height: 100%; background-color: var(--blue-main); transition: width 0.5s ease-in-out; display: flex; align-items: center; justify-content: flex-end; }
        .bar-segment-right { height: 100%; background-color: var(--blue-main); transition: width 0.5s ease-in-out; display: flex; align-items: center; justify-content: flex-start; }
        .bar-text-label { width: 15%; font-size: 1rem; font-weight: 700; color: #1f2937; display: flex; align-items: center; }
        .bar-text-label-left { justify-content: flex-start; }
        .bar-text-label-right { justify-content: flex-end; }
        .bar-wrapper { display: flex; align-items: center; gap: 0.5rem; }
        .bar-icon { padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 1rem; font-weight: 700; color: white; background-color: var(--blue-main); }
        .dimension-card { padding: 1.25rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); display: flex; flex-direction: column; align-items: center; gap: 0.75rem; }
        .dimension-icon { width: 2rem; height: 2rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); }
        .persuade-button { background: linear-gradient(135deg, #ef4444, #f472b6); transition: all 0.3s ease; }
        .persuade-button:hover { background: linear-gradient(135deg, #dc2626, #ec4899); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3); }
    </style>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="flex justify-center py-10 md:py-16 px-4">

<div class="max-w-xl w-full space-y-8">

    <div style="display: none;">
        <input type="hidden" id="hiddenTitle" th:value="${title ?: ''}" />
        <input type="hidden" id="hiddenCharacterName" th:value="${characterName ?: ''}" />
        <input type="hidden" id="hiddenCategory" th:value="${category ?: ''}" />

        <input type="hidden" id="hiddenUserFullMbti" th:value="${ei + sn + tf + jp ?: ''}" />
        <input type="hidden" id="hiddenAiFullMbti" th:value="${fullAiMbti ?: ''}" />

        <input type="hidden" id="hiddenValueE" th:value="${valueE ?: '0'}" />
        <input type="hidden" id="hiddenValueI" th:value="${valueI ?: '0'}" />
        <input type="hidden" id="hiddenValueS" th:value="${valueS ?: '0'}" />
        <input type="hidden" id="hiddenValueN" th:value="${valueN ?: '0'}" />
        <input type="hidden" id="hiddenValueT" th:value="${valueT ?: '0'}" />
        <input type="hidden" id="hiddenValueF" th:value="${valueF ?: '0'}" />
        <input type="hidden" id="hiddenValueJ" th:value="${valueJ ?: '0'}" />
        <input type="hidden" id="hiddenValueP" th:value="${valueP ?: '0'}" />

        <input type="hidden" id="hiddenAiEi" th:value="${aiEi ?: ''}" />
        <input type="hidden" id="hiddenAiSn" th:value="${aiSn ?: ''}" />
        <input type="hidden" id="hiddenAiTf" th:value="${aiTf ?: ''}" />
        <input type="hidden" id="hiddenAiJp" th:value="${aiJp ?: ''}" />

        <input type="hidden" id="hiddenUserEi" th:value="${ei ?: ''}" />
        <input type="hidden" id="hiddenUserSn" th:value="${sn ?: ''}" />
        <input type="hidden" id="hiddenUserTf" th:value="${tf ?: ''}" />
        <input type="hidden" id="hiddenUserJp" th:value="${jp ?: ''}" />
    </div>

    <form id="persuade-form" th:action="@{/persudade/transfer-to-persuade}" method="post" style="display: none;">
        <input type="hidden" name="title" id="formTitle">
        <input type="hidden" name="characterName" id="formCharacterName">
        <input type="hidden" name="category" id="formCategory">
        <input type="hidden" name="aiThing" id="formAiThing">
        <input type="hidden" name="fullMbti" id="formFullMbti">
        <input type="hidden" name="valueE" id="formValueE">
        <input type="hidden" name="valueI" id="formValueI">
        <input type="hidden" name="valueS" id="formValueS">
        <input type="hidden" name="valueN" id="formValueN">
        <input type="hidden" name="valueT" id="formValueT">
        <input type="hidden" name="valueF" id="formValueF">
        <input type="hidden" name="valueJ" id="formValueJ">
        <input type="hidden" name="valueP" id="formValueP">
        <input type="hidden" name="ei" id="formEi">
        <input type="hidden" name="sn" id="formSn">
        <input type="hidden" name="tf" id="formTf">
        <input type="hidden" name="jp" id="formJp">
    </form>


    <div class="result-box bg-white border border-gray-200 space-y-3">
        <p class="font-bold text-lg flex items-center text-blue-700">
            <i data-lucide="square-user" class="w-6 h-6 mr-2 text-blue-500"></i> ë¶„ì„ ëŒ€ìƒ ì •ë³´
        </p>
        <div class="info-detail space-y-1 text-base">
            <p>ì œëª©: <span class="font-semibold text-gray-800" th:text="${title ?: 'N/A'}">ì‘í’ˆ ì œëª©</span></p>
            <p>ë“±ì¥ì¸ë¬¼: <span class="font-semibold text-gray-800" th:text="${characterName ?: 'N/A'}">ë“±ì¥ì¸ë¬¼ ì´ë¦„</span></p>
            <p>ì¹´í…Œê³ ë¦¬: <span class="font-semibold text-gray-800" th:text="${category ?: 'N/A'}">ì¹´í…Œê³ ë¦¬</span></p>
        </div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-lg space-y-5">
        <h2 class="text-lg font-bold text-gray-800 flex items-center">
            <i data-lucide="activity" class="w-5 h-5 mr-2 text-blue-500"></i> AI ë¶„ì„ ìƒì„¸ ì§€í‘œ
        </h2>

        <div id="bar-charts-container" class="space-y-4">
        </div>

    </div>

    <div id="mbti-message-container">
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="mbti-dimension-cards-container">
    </div>

    <div class="bg-white p-5 rounded-xl shadow-lg" id="persuade-section">
        <h3 class="text-base font-bold text-gray-800 mb-4">ì„¤ë“ ëŒ€ìƒ ì°¨ì›</h3>
        <div class="flex flex-wrap gap-3">
        </div>
    </div>

    <div class="flex justify-center pt-4">
        <button id="persuade-button" class="persuade-button w-full max-w-md py-4 rounded-full text-white font-bold text-lg shadow-lg flex items-center justify-center gap-3">
            <i data-lucide="swords" class="w-6 h-6"></i>
            <span>ì„¤ë“ ëŒ€ê²° ì‹œì‘í•˜ê¸°</span>
        </button>
    </div>


</div>

<script>
    // Lucide Icons ì´ˆê¸°í™” (ì•„ì´ì½˜ ë Œë”ë§)
    lucide.createIcons();

    // --------------------------------------------------
    // 0. Hidden Fieldì—ì„œ ê°’ ì½ì–´ì˜¤ê¸° (ë³€ìˆ˜ ì„ ì–¸)
    // --------------------------------------------------
    const hiddenTitle = document.getElementById('hiddenTitle');
    const hiddenCharacterName = document.getElementById('hiddenCharacterName');
    const hiddenCategory = document.getElementById('hiddenCategory');

    const hiddenUserFullMbti = document.getElementById('hiddenUserFullMbti'); // ì‚¬ìš©ì ì „ì²´ MBTI
    const hiddenAiFullMbti = document.getElementById('hiddenAiFullMbti'); // AI ì „ì²´ MBTI

    // ìƒì„¸ ê°’ì€ ë°” ì°¨íŠ¸ ë Œë”ë§ì— ì‚¬ìš©
    const hiddenValueE = document.getElementById('hiddenValueE');
    const hiddenValueI = document.getElementById('hiddenValueI');
    const hiddenValueS = document.getElementById('hiddenValueS');
    const hiddenValueN = document.getElementById('hiddenValueN');
    const hiddenValueT = document.getElementById('hiddenValueT');
    const hiddenValueF = document.getElementById('hiddenValueF');
    const hiddenValueJ = document.getElementById('hiddenValueJ');
    const hiddenValueP = document.getElementById('hiddenValueP');

    const hiddenAiEi = document.getElementById('hiddenAiEi');
    const hiddenAiSn = document.getElementById('hiddenAiSn');
    const hiddenAiTf = document.getElementById('hiddenAiTf');
    const hiddenAiJp = document.getElementById('hiddenAiJp');

    const hiddenUserEi = document.getElementById('hiddenUserEi');
    const hiddenUserSn = document.getElementById('hiddenUserSn');
    const hiddenUserTf = document.getElementById('hiddenUserTf');
    const hiddenUserJp = document.getElementById('hiddenUserJp');

    // AIì™€ ì‚¬ìš©ì MBTIê°€ ì¼ì¹˜í•˜ëŠ”ì§€ íŒë‹¨
    const isMbtiMatch = hiddenUserFullMbti.value === hiddenAiFullMbti.value;


    // --------------------------------------------------
    // 1. ê°œë³„ ì§€í‘œ ë™ì  ë Œë”ë§ í•¨ìˆ˜ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    // --------------------------------------------------
    function renderDimensionCards() {
        const gridContainer = document.getElementById('mbti-dimension-cards-container');
        gridContainer.innerHTML = '';

        const dimensions = [
            { name: "ì—ë„ˆì§€ ë°©í–¥", user: hiddenUserEi.value, ai: hiddenAiEi.value, options: ['E', 'I'], type: 'E/I' },
            { name: "ì¸ì‹ ê¸°ëŠ¥", user: hiddenUserSn.value, ai: hiddenAiSn.value, options: ['S', 'N'], type: 'S/N' },
            { name: "íŒë‹¨ ê¸°ëŠ¥", user: hiddenUserTf.value, ai: hiddenAiTf.value, options: ['T', 'F'], type: 'T/F' },
            { name: "ìƒí™œ ì–‘ì‹", user: hiddenUserJp.value, ai: hiddenAiJp.value, options: ['J', 'P'], type: 'J/P' }
        ];

        let nonMatchDimensions = [];

        dimensions.forEach(dim => {
            const isMatch = dim.user !== '' && dim.ai !== '' && dim.user === dim.ai;

            if (dim.user === '' || dim.ai === '') {
                // console.error(`Error: Data missing for ${dim.name} dimension.`);
                return;
            }

            const statusText = isMatch ? 'ì¼ì¹˜' : 'ë¶ˆì¼ì¹˜';
            const statusClass = isMatch ? 'bg-green-50' : 'bg-orange-50';
            const statusTextColor = isMatch ? 'text-green-600' : 'text-red-600';
            const iconBgClass = isMatch ? 'bg-green-500' : 'bg-red-500';
            const iconName = isMatch ? 'check' : 'x';

            const userIconBgClass = isMatch ? 'bg-green-500' : 'bg-purple-500';
            const aiIconBgClass = isMatch ? 'bg-green-500' : 'bg-blue-500';

            if (!isMatch) {
                nonMatchDimensions.push(`${dim.type} (${dim.name})`);
            }

            const cardHtml = `
                <div class="dimension-card ${statusClass}">
                    <p class="text-sm font-bold text-gray-800 text-left w-full">${dim.name}</p>
                    <div class="flex items-center justify-center gap-2">
                        <div class="dimension-icon ${userIconBgClass} text-white">${dim.user || '?'}</div>
                        <div class="dimension-icon ${iconBgClass} text-white">
                            <i data-lucide="${iconName}" class="w-5 h-5"></i>
                        </div>
                        <div class="dimension-icon ${aiIconBgClass} text-white">${dim.ai || '?'}</div>
                    </div>
                    <span class="text-sm font-semibold ${statusTextColor}">${statusText}</span>
                </div>
            `;
            gridContainer.innerHTML += cardHtml;
        });

        renderPersuadeButtons(nonMatchDimensions);
        lucide.createIcons();
    }

    // --------------------------------------------------
    // 2. ì„¤ë“ ëŒ€ìƒ ë²„íŠ¼ ë Œë”ë§ í•¨ìˆ˜ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    // --------------------------------------------------
    function renderPersuadeButtons(nonMatchDimensions) {
        const persuadeTargetContainer = document.querySelector('#persuade-section .flex.flex-wrap.gap-3');
        const persuadeSection = document.getElementById('persuade-section');
        persuadeTargetContainer.innerHTML = '';

        if (nonMatchDimensions.length > 0) {
            nonMatchDimensions.forEach(dimText => {
                const buttonHtml = `
                    <button type="button" class="px-4 py-2 bg-orange-100 hover:bg-orange-200 text-orange-700 font-semibold rounded-lg transition-colors text-sm">
                        ${dimText}
                    </button>
                `;
                persuadeTargetContainer.innerHTML += buttonHtml;
            });
            persuadeSection.style.display = 'block';

        } else {
            persuadeSection.style.display = 'none';
        }
    }

    // --------------------------------------------------
    // 3. ğŸŒŸ ë°” ì°¨íŠ¸ ë Œë”ë§ í•¨ìˆ˜ (ìƒˆë¡œ ì¶”ê°€) ğŸŒŸ
    // --------------------------------------------------
    function renderBarCharts() {
        const barContainer = document.getElementById('bar-charts-container');
        barContainer.innerHTML = '';

        const chartData = [
            { type: "ì—ë„ˆì§€ì˜ ë°©í–¥ì„±", left: 'E', right: 'I', valLeft: parseInt(hiddenValueE.value), valRight: parseInt(hiddenValueI.value), labelLeft: 'ì™¸í–¥', labelRight: 'ë‚´í–¥' },
            { type: "ì¸ì‹ ê¸°ëŠ¥", left: 'S', right: 'N', valLeft: parseInt(hiddenValueS.value), valRight: parseInt(hiddenValueN.value), labelLeft: 'ê°ê°', labelRight: 'ì§ê´€' },
            { type: "íŒë‹¨ ê¸°ëŠ¥", left: 'T', right: 'F', valLeft: parseInt(hiddenValueT.value), valRight: parseInt(hiddenValueF.value), labelLeft: 'ì‚¬ê³ ', labelRight: 'ê°ì •' },
            { type: "ìƒí™œ ì–‘ì‹", left: 'J', right: 'P', valLeft: parseInt(hiddenValueJ.value), valRight: parseInt(hiddenValueP.value), labelLeft: 'íŒë‹¨', labelRight: 'ì¸ì‹' }
        ];

        chartData.forEach(data => {
            const total = data.valLeft + data.valRight;

            // ê°’ì´ ëª¨ë‘ 0ì¸ ê²½ìš°ëŠ” ë Œë”ë§í•˜ì§€ ì•ŠìŒ
            if (total === 0) return;

            const percentLeft = Math.round((data.valLeft / total) * 100);
            const percentRight = 100 - percentLeft;

            // ë” í° ê°’ì— ë”°ë¼ ìƒ‰ìƒ í´ë˜ìŠ¤ ê²°ì •
            const colorLeft = (percentLeft > percentRight) ? 'var(--blue-main)' : '#e5e7eb';
            const colorRight = (percentRight > percentLeft) ? 'var(--blue-main)' : '#e5e7eb';

            // ë¹„ìœ¨ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ê²°ì • (ìƒ‰ìƒì´ íŒŒë€ìƒ‰ì¸ ë¶€ë¶„ì€ í°ìƒ‰ í…ìŠ¤íŠ¸, íšŒìƒ‰ì¸ ë¶€ë¶„ì€ ê²€ì€ìƒ‰ í…ìŠ¤íŠ¸)
            const textLeftColor = (percentLeft > percentRight) ? 'white' : '#1f2937';
            const textRightColor = (percentRight > percentLeft) ? 'white' : '#1f2937';

            const itemHtml = `
                <div class="bar-chart-item">
                    <div class="flex justify-between text-base font-semibold mb-1 text-gray-800">
                        <span class="bar-text-label-left flex items-center gap-1">
                            <span class="bar-icon">${data.left}</span> ${data.labelLeft}
                        </span>
                        <span>
                            ${data.type}
                        </span>
                        <span class="bar-text-label-right flex items-center gap-1">
                            ${data.labelRight} <span class="bar-icon">${data.right}</span>
                        </span>
                    </div>
                    <div class="bar-container-new">
                        <div class="bar-segment-left" style="width: ${percentLeft}%; background-color: ${colorLeft};"></div>
                        <div class="bar-segment-right" style="width: ${percentRight}%; background-color: ${colorRight};"></div>
                        <div class="bar-label-overlay">
                            <span style="width: ${percentLeft}%; text-align: right; padding-right: 0.5rem; color: ${textLeftColor};">${percentLeft}%</span>
                            <span style="width: ${percentRight}%; text-align: left; padding-left: 0.5rem; color: ${textRightColor};">${percentRight}%</span>
                        </div>
                    </div>
                </div>
            `;
            barContainer.innerHTML += itemHtml;
        });
    }

    // --------------------------------------------------
    // 4. ì„¤ë“ ëŒ€ê²° ì‹œì‘í•˜ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    // --------------------------------------------------
    const persuadeButton = document.getElementById('persuade-button');
    const form = document.getElementById('persuade-form');

    persuadeButton.addEventListener('click', () => {

        // í¼ í•„ë“œì— ê°’ ì±„ì›Œë„£ê¸° (POST ì „ì†¡ ì¤€ë¹„)
        document.getElementById('formTitle').value = hiddenTitle.value;
        document.getElementById('formCharacterName').value = hiddenCharacterName.value;
        document.getElementById('formCategory').value = hiddenCategory.value;
        document.getElementById('formAiThing').value = document.getElementById('hiddenAiThing') ? document.getElementById('hiddenAiThing').value : '';
        document.getElementById('formFullMbti').value = hiddenUserFullMbti.value;

        document.getElementById('formValueE').value = hiddenValueE.value;
        document.getElementById('formValueI').value = hiddenValueI.value;
        document.getElementById('formValueS').value = hiddenValueS.value;
        document.getElementById('formValueN').value = hiddenValueN.value;
        document.getElementById('formValueT').value = hiddenValueT.value;
        document.getElementById('formValueF').value = hiddenValueF.value;
        document.getElementById('formValueJ').value = hiddenValueJ.value;
        document.getElementById('formValueP').value = hiddenValueP.value;

        document.getElementById('formEi').value = hiddenUserEi.value;
        document.getElementById('formSn').value = hiddenUserSn.value;
        document.getElementById('formTf').value = hiddenUserTf.value;
        document.getElementById('formJp').value = hiddenUserJp.value;

        form.submit();
    });

    // --------------------------------------------------
    // 5. í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” ë° ë Œë”ë§ í˜¸ì¶œ
    // --------------------------------------------------

    // ì „ì²´ ì¼ì¹˜ ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ ë Œë”ë§
    const mbtiMessageContainer = document.getElementById('mbti-message-container');

    if (isMbtiMatch) {
        mbtiMessageContainer.innerHTML = `<div class="bg-green-50 border border-green-200 rounded-xl p-4 flex items-start gap-3"><div class="flex-shrink-0"><i data-lucide="check-circle" class="w-6 h-6 text-green-500"></i></div><p class="text-sm text-green-800 flex-1 leading-relaxed"><span class="font-semibold">ë¶„ì„ì´ ì¼ì¹˜í•©ë‹ˆë‹¤!</span> ë‹¹ì‹ ì´ ì˜ˆì¸¡í•œ MBTIì™€ AIì˜ ë¶„ì„ ê²°ê³¼ê°€ ì™„ë²½í•˜ê²Œ ì¼ì¹˜í–ˆìŠµë‹ˆë‹¤.</p></div>`;
    } else {
        mbtiMessageContainer.innerHTML = `<div class="bg-orange-50 border border-orange-200 rounded-xl p-4 flex items-start gap-3"><div class="flex-shrink-0"><i data-lucide="alert-triangle" class="w-6 h-6 text-orange-500"></i></div><p class="text-sm text-orange-800 flex-1 leading-relaxed"><span class="font-semibold">ë¶„ì„ ì°¨ì´ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.</span> AIì™€ 2ê°œì˜ ì¶œì²˜ê°€ ì„œë¡œ ë‹¤ë¥¸ ë¶„ì„ ê²°ê³¼ë¥¼ ë„ì¶œí–ˆìŠµë‹ˆë‹¤. ì‘í’ˆì˜ ê·¼ê±°ì™€ ë…¼ë¦¬ë¡œ AIë¥¼ ì„¤ë“í•´ì£¼ì„¸ìš”!</p></div>`;
    }

    // ğŸŒŸ ë°” ì°¨íŠ¸ ë Œë”ë§ í•¨ìˆ˜ ì‹¤í–‰ (ê°€ì¥ ë¨¼ì € í‘œì‹œ)
    renderBarCharts();

    // ê°œë³„ ì§€í‘œ ì¹´ë“œ ë Œë”ë§ í•¨ìˆ˜ ì‹¤í–‰
    renderDimensionCards();

    // ë™ì  ì‚½ì…ëœ ì•„ì´ì½˜ ì¬ë Œë”ë§
    lucide.createIcons();

</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${title} + ' MBTI 분석 결과 상세'">MBTI 분석 결과 상세</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS Variables */
        :root {
            --primary-purple: #a238ff; /* 메인 보라색 */
            --secondary-pink: #ff3ca6; /* 서브 핑크색 */
            --blue-main: #7c3aed; /* 바 차트 메인 색상 (Violet) */
            --bg-gradient: radial-gradient(circle at top left, #ede9fe 0%, #f3e8ff 50%, #ffffff 100%); /* 배경 그라데이션 */

            /* Custom colors for image matching */
            --match-green-bg: #f0fff4; /* 연한 녹색 배경 */
            --match-green-border: #34d399; /* 녹색 테두리 */
            --mismatch-orange-bg: #fff7ed; /* 연한 주황색 배경 */
            --mismatch-orange-border: #fb923c; /* 주황색 테두리 */

            /* New icon colors for dual display */
            --user-purple: #a238ff;
            --ai-blue: #3b82f6; /* Tailwind blue-500 */
            --match-green: #10b981; /* Tailwind emerald-500 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
        }

        .result-box {
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        /* Bar Chart Styles */
        .bar-chart-item { margin-bottom: 1rem; }
        .bar-container-new {
            display: flex; height: 35px; border-radius: 9999px; overflow: hidden;
            background-color: #e5e7eb; margin-top: 5px; position: relative;
        }
        .bar-label-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; justify-content: center; align-items: center;
            font-size: 0.875rem; font-weight: 600; color: #1f2937;
        }
        .bar-segment-left { height: 100%; transition: width 0.5s ease-in-out; }
        .bar-segment-right { height: 100%; transition: width 0.5s ease-in-out; }
        .bar-icon { padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 1rem; font-weight: 700; color: white; background-color: var(--blue-main); }
        .dimension-card {
            padding: 1.25rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            text-align: center;
            border-width: 1px;
        }
        /* MBTI Letter Icon Styles */
        .dimension-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 8px; /* Rounded rectangle */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
            background-color: white; /* White background */
            border-style: solid;
            border-width: 1px;
        }

        /* 중앙 상태 아이콘 (X 또는 V) */
        .status-icon {
            /* Positioning for between two icons */
            position: relative;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 900;
            color: white;
            z-index: 10;
            line-height: 1;
            /* Use negative margin to visually overlap icons slightly */
            margin: 0 -0.75rem;
        }
        .check-icon {
            background-color: var(--match-green); /* Green check */
        }
        .x-icon {
            background-color: #f97316; /* Orange X */
            border: 2px solid var(--mismatch-orange-bg); /* 연한 배경색과 유사한 테두리 추가 */
            color: #fff;
        }

        /* Persuade Button Gradient */
        .persuade-button { background: linear-gradient(135deg, var(--primary-purple), var(--secondary-pink)); transition: all 0.3s ease; }
        .persuade-button:hover {
            background: linear-gradient(135deg, #8b5cf6, #f9a8d4);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(162, 56, 255, 0.3);
        }

        /* 설득 대상 버튼 스타일 조정 */
        .persuade-target-button {
            padding: 0.5rem 1rem;
            background-color: #f97316; /* Orange-600 */
            color: white;
            font-weight: bold;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .match-status-text {
            font-weight: 800; /* Extra bold */
            font-size: 0.9rem; /* Slightly larger text */
            margin-top: 0.25rem;
        }

        /* Custom MBTI Card Styles */
        .mbti-display-card {
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .mbti-icon-circle {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .mbti-type-box {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1.25rem; /* text-xl */
            width: fit-content;
            margin-top: 0.75rem;
        }
    </style>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="flex justify-center py-10 md:py-16 px-4">

<div class="max-w-xl w-full space-y-8">

    <!-- Hidden Fields for data transfer -->
    <div style="display: none;">
        <input type="hidden" id="hiddenTitle" th:value="${title ?: ''}" />
        <input type="hidden" id="hiddenCharacterName" th:value="${characterName ?: ''}" />
        <input type="hidden" id="hiddenCategory" th:value="${category ?: ''}" />

        <input type="hidden" id="hiddenUserFullMbti" th:value="${ei + sn + tf + jp ?: ''}" />
        <input type="hidden" id="hiddenAiFullMbti" th:value="${fullAiMbti ?: ''}" />

        <input type="hidden" id="hiddenValueE" th:value="${valueE ?: '0'}" />
        <input type="hidden" id="hiddenValueI" th:value="${valueI ?: '0'}" />
        <input type="hidden" id="hiddenValueS" th:value="${valueS ?: '0'}" />
        <input type="hidden" id="hiddenValueN" th:value="${valueN ?: '0'}" />
        <input type="hidden" id="hiddenValueT" th:value="${valueT ?: '0'}" />
        <input type="hidden" id="hiddenValueF" th:value="${valueF ?: '0'}" />
        <input type="hidden" id="hiddenValueJ" th:value="${valueJ ?: '0'}" />
        <input type="hidden" id="hiddenValueP" th:value="${valueP ?: '0'}" />

        <input type="hidden" id="hiddenAiThing" th:value="${aiThing ?: ''}" />
        <input type="hidden" id="hiddenAiEi" th:value="${aiEi ?: ''}" />
        <input type="hidden" id="hiddenAiSn" th:value="${sn ?: ''}" />
        <input type="hidden" id="hiddenAiTf" th:value="${tf ?: ''}" />
        <input type="hidden" id="hiddenAiJp" th:value="${jp ?: ''}" />

        <input type="hidden" id="hiddenUserEi" th:value="${ei ?: ''}" />
        <input type="hidden" id="hiddenUserSn" th:value="${sn ?: ''}" />
        <input type="hidden" id="hiddenUserTf" th:value="${tf ?: ''}" />
        <input type="hidden" id="hiddenUserJp" th:value="${jp ?: ''}" />

        <!-- Controller에서 넘어온 불일치 Boolean 값 -->
        <input type="hidden" id="hiddenEiMismatch" th:value="${eiMismatch ?: false}" />
        <input type="hidden" id="hiddenSnMismatch" th:value="${snMismatch ?: false}" />
        <input type="hidden" id="hiddenTfMismatch" th:value="${tfMismatch ?: false}" />
        <input type="hidden" id="hiddenJpMismatch" th:value="${jpMismatch ?: false}" />
    </div>

    <!-- Form for POST request -->
    <form id="persuade-form" th:action="@{/persudade/transfer-to-persuade}" method="post" style="display: none;">
        <input type="hidden" name="title" id="formTitle">
        <input type="hidden" name="characterName" id="formCharacterName">
        <input type="hidden" name="category" id="formCategory">
        <input type="hidden" name="aiThing" id="formAiThing">
        <input type="hidden" name="fullMbti" id="formFullMbti">
        <input type="hidden" name="valueE" id="formValueE">
        <input type="hidden" name="valueI" id="formValueI">
        <input type="hidden" name="valueS" id="formValueS">
        <input type="hidden" name="valueN" id="formValueN">
        <input type="hidden" name="valueT" id="formValueT">
        <input type="hidden" name="valueF" id="formValueF">
        <input type="hidden" name="valueJ" id="formValueJ">
        <input type="hidden" name="valueP" id="formValueP">
        <input type="hidden" name="ei" id="formEi">
        <input type="hidden" name="sn" id="formSn">
        <input type="hidden" name="tf" id="formTf">
        <input type="hidden" name="jp" id="formJp">
    </form>


    <!-- 1. 분석 대상 정보 -->
    <div class="result-box bg-white border border-gray-200 space-y-3">
        <p class="font-bold text-lg flex items-center text-purple-700"> <i data-lucide="square-user" class="w-6 h-6 mr-2 text-purple-500"></i> 분석 대상 정보
        </p>
        <div class="info-detail space-y-1 text-base">
            <p>제목: <span class="font-semibold text-gray-800" th:text="${title ?: 'N/A'}">작품 제목</span></p>
            <p>등장인물: <span class="font-semibold text-gray-800" th:text="${characterName ?: 'N/A'}">등장인물 이름</span></p>
            <p>카테고리: <span class="font-semibold text-gray-800" th:text="${category ?: 'N/A'}">카테고리</span></p>
        </div>
    </div>

    <!-- 2. MBTI 예측 결과 비교 카드 -->
    <div class="grid grid-cols-2 gap-4">
        <!-- 당신이 예측한 MBTI 카드 -->
        <div class="mbti-display-card" style="background-color: #f3e8ff; border: 1px solid #d8b4fe;">
            <div class="flex items-center gap-3">
                <div class="mbti-icon-circle bg-purple-500">
                    <i data-lucide="user" class="w-5 h-5"></i>
                </div>
                <span class="font-semibold text-purple-800 text-sm">당신이 예측한 MBTI</span>
            </div>
            <!-- MBTI 값 표시 -->
            <div class="mbti-type-box bg-purple-600 text-white shadow-md" th:text="${ei + sn + tf + jp ?: 'N/A'}">
                ESTJ <!-- Thymeleaf가 없을 경우를 대비한 placeholder -->
            </div>
        </div>

        <!-- AI가 분석한 MBTI 카드 -->
        <div class="mbti-display-card" style="background-color: #eff6ff; border: 1px solid #93c5fd;">
            <div class="flex items-center gap-3">
                <div class="mbti-icon-circle bg-blue-600">
                    <i data-lucide="brain" class="w-5 h-5"></i>
                </div>
                <span class="font-semibold text-blue-800 text-sm">AI가 분석한 MBTI</span>
            </div>
            <!-- MBTI 값 표시 -->
            <div class="mbti-type-box bg-blue-600 text-white shadow-md" th:text="${fullAiMbti ?: 'N/A'}">
                ISFJ <!-- Thymeleaf가 없을 경우를 대비한 placeholder -->
            </div>
        </div>
    </div>


    <!-- 3. AI 분석 상세 지표 (바 차트) -->
    <div class="bg-white p-6 rounded-xl shadow-lg space-y-5">
        <h2 class="text-lg font-bold text-gray-800 flex items-center">
            <i data-lucide="activity" class="w-5 h-5 mr-2 text-purple-500"></i> AI 분석 상세 지표 (퍼센트)
        </h2>
        <div id="bar-charts-container" class="space-y-4">
        </div>
    </div>

    <!-- 4. AI/사용자 MBTI 일치/불일치 메시지 -->
    <div id="mbti-message-container">
    </div>

    <!-- ⭐️ 5. MBTI 개별 차원 비교 카드 (순서 변경됨) ⭐️ -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="mbti-dimension-cards-container">
        <!-- JS로 채워짐 -->
    </div>
    <!-- ⭐️ END: MBTI 개별 차원 비교 카드 ⭐️ -->

    <!-- 6. 설득 대상 차원 버튼 (순서 변경됨) -->
    <div class="bg-white p-5 rounded-xl shadow-lg" id="persuade-section">
        <h3 class="text-base font-bold text-gray-800 mb-4">설득 대상 차원</h3>
        <div class="flex flex-wrap gap-3">
            <!-- JS로 채워짐 -->
        </div>
    </div>
    <!-- END: 설득 대상 차원 버튼 -->

    <!-- 7. 설득 대결 시작 버튼 -->
    <div class="flex justify-center pt-4">
        <button id="persuade-button" class="persuade-button w-full max-w-md py-4 rounded-full text-white font-bold text-lg shadow-lg flex items-center justify-center gap-3">
            <i data-lucide="swords" class="w-6 h-6"></i>
            <span>설득 대결 시작하기</span>
        </button>
    </div>


</div>

<script>
    // Lucide Icons 초기화 (아이콘 렌더링)
    lucide.createIcons();

    // --------------------------------------------------
    // 0. Hidden Field에서 값 읽어오기 (변수 선언)
    // --------------------------------------------------
    const hiddenTitle = document.getElementById('hiddenTitle');
    const hiddenCharacterName = document.getElementById('hiddenCharacterName');
    const hiddenCategory = document.getElementById('hiddenCategory');
    const hiddenUserFullMbti = document.getElementById('hiddenUserFullMbti');
    const hiddenAiFullMbti = document.getElementById('hiddenAiFullMbti');
    const hiddenAiThing = document.getElementById('hiddenAiThing');

    // 상세 값은 바 차트 렌더링에 사용
    const hiddenValueE = document.getElementById('hiddenValueE');
    const hiddenValueI = document.getElementById('hiddenValueI');
    const hiddenValueS = document.getElementById('hiddenValueS');
    const hiddenValueN = document.getElementById('hiddenValueN');
    const hiddenValueT = document.getElementById('hiddenValueT');
    const hiddenValueF = document.getElementById('hiddenValueF');
    const hiddenValueJ = document.getElementById('hiddenValueJ');
    const hiddenValueP = document.getElementById('hiddenValueP');

    // 개별 MBTI 지표
    const hiddenAiEi = document.getElementById('hiddenAiEi');
    const hiddenAiSn = document.getElementById('hiddenAiSn');
    const hiddenAiTf = document.getElementById('hiddenAiTf');
    const hiddenAiJp = document.getElementById('hiddenAiJp');
    const hiddenUserEi = document.getElementById('hiddenUserEi');
    const hiddenUserSn = document.getElementById('hiddenUserSn');
    const hiddenUserTf = document.getElementById('hiddenUserTf');
    const hiddenUserJp = document.getElementById('hiddenUserJp');

    // 불일치 여부 (Controller에서 Boolean으로 넘어옴)
    const eiMismatch = document.getElementById('hiddenEiMismatch').value === 'true';
    const snMismatch = document.getElementById('hiddenSnMismatch').value === 'true';
    const tfMismatch = document.getElementById('hiddenTfMismatch').value === 'true';
    const jpMismatch = document.getElementById('hiddenJpMismatch').value === 'true';

    // AI와 사용자 MBTI가 전체적으로 일치하는지 판단
    const isMbtiMatch = !(eiMismatch || snMismatch || tfMismatch || jpMismatch);


    // --------------------------------------------------
    // 1. 개별 지표 동적 렌더링 함수 (불일치 정보 반영 - 이미지 맞춤)
    // --------------------------------------------------
    function renderDimensionCards() {
        const gridContainer = document.getElementById('mbti-dimension-cards-container');
        gridContainer.innerHTML = '';

        const dimensions = [
            { name: "에너지 방향", user: hiddenUserEi.value, ai: hiddenAiEi.value, isMatch: !eiMismatch, type: 'E/I', options: ['E', 'I'] },
            { name: "인식 기능", user: hiddenUserSn.value, ai: hiddenAiSn.value, isMatch: !snMismatch, type: 'S/N', options: ['S', 'N'] },
            { name: "판단 기능", user: hiddenUserTf.value, ai: hiddenAiTf.value, isMatch: !tfMismatch, type: 'T/F', options: ['T', 'F'] },
            { name: "생활 양식", user: hiddenUserJp.value, ai: hiddenAiJp.value, isMatch: !jpMismatch, type: 'J/P', options: ['J', 'P'] }
        ];

        let nonMatchDimensions = [];

        // 아이콘 배경색:
        const userColor = 'var(--user-purple)'; // 사용자 (보라)
        const aiColor = 'var(--ai-blue)'; // AI (파랑)
        const matchColor = 'var(--match-green)'; // 일치 (녹색)

        const getIconHtml = (option, dimType, isUser, isAi, isMatch) => {
            let customStyle = '';

            // 1. 색상 결정
            if (isMatch) {
                if (isUser || isAi) {
                    // 일치 시 (선택된 유형) -> 녹색 배경 & 테두리
                    customStyle = `background-color: ${matchColor}; border-color: ${matchColor}; color: white;`;
                } else {
                    // 일치 시 (선택되지 않은 반대 유형) -> 흰색 배경, 회색 테두리
                    customStyle = `background-color: white; border-color: #d1d5db; color: #9ca3af;`; // Tailwind gray-300/400
                }
            } else {
                // 불일치 시 (Mismatch)
                if (isUser) {
                    // 사용자 선택 유형: 보라색 배경 & 테두리
                    customStyle = `background-color: ${userColor}; border-color: ${userColor}; color: white;`;
                } else if (isAi) {
                    // AI 분석 유형:
                    // [변경]: E/I일 때만 파란색 배경 전체 (이미지처럼), 나머지 지표는 흰색 배경/파란색 테두리
                    if (dimType === 'E/I') {
                        customStyle = `background-color: ${aiColor}; border-color: ${aiColor}; color: white;`;
                    } else {
                        // SN, TF, JP일 때는 흰색 배경, 파란색 테두리 (이미지처럼)
                        customStyle = `background-color: white; border-color: ${aiColor}; color: ${aiColor};`;
                    }
                } else {
                    // 아무도 선택하지 않은 유형 -> 흰색 배경, 회색 테두리
                    customStyle = `background-color: white; border-color: #d1d5db; color: #9ca3af;`;
                }
            }

            return `
                <div class="dimension-icon"
                     style="${customStyle}; border-width: 1px; border-style: solid;">
                    ${option}
                </div>
            `;
        };


        dimensions.forEach(dim => {
            const isMatch = dim.isMatch;

            // 데이터 누락 체크
            if (dim.user === '' || dim.ai === '') {
                return;
            }

            const statusText = isMatch ? '일치' : '불일치';

            // 이미지와 동일하게 불일치 시 오렌지, 일치 시 연한 녹색 배경 및 테두리 설정
            const statusClass = isMatch
                ? 'bg-[var(--match-green-bg)] border-[var(--match-green-border)]'
                : 'bg-[var(--mismatch-orange-bg)] border-[var(--mismatch-orange-border)]';
            const statusTextColor = isMatch ? 'text-green-800' : 'text-orange-800';


            // MBTI 아이콘 HTML 구성
            const option1 = dim.options[0]; // E, S, T, J
            const option2 = dim.options[1]; // I, N, F, P

            // 좌측 (option1) 아이콘 처리
            const isUser1 = dim.user === option1;
            const isAi1 = dim.ai === option1;

            // 우측 (option2) 아이콘 처리
            const isUser2 = dim.user === option2;
            const isAi2 = dim.ai === option2;

            // 중앙 상태 아이콘 (X 또는 V)
            let centerIconHtml = '';
            if (!isMatch) {
                // 불일치 시 X 아이콘 (주황색)
                centerIconHtml = `<span class="status-icon x-icon">&#10006;</span>`;
            } else {
                // 일치 시 V 아이콘 (녹색)
                centerIconHtml = `<span class="status-icon check-icon">&#10003;</span>`;
            }

            // 사용자 vs AI 아이콘 배치 (두 칸짜리 레이아웃)
            const iconBlockHtml = `
                <div class="flex items-center justify-center w-full">
                    <!-- Option 1 (E/S/T/J) -->
                    ${getIconHtml(option1, dim.type, isUser1, isAi1, isMatch)}

                    <!-- 중앙 상태 아이콘 (X 또는 V) -->
                    ${centerIconHtml}

                    <!-- Option 2 (I/N/F/P) -->
                    ${getIconHtml(option2, dim.type, isUser2, isAi2, isMatch)}
                </div>
            `;

            // --- 최종 HTML 카드 구조 ---
            const cardHtml = `
                <div class="dimension-card ${statusClass} flex-1 min-w-[45%]">
                    <p class="font-bold text-base text-gray-800">${dim.name}</p>
                    <div class="flex items-center justify-center gap-4">
                        ${iconBlockHtml}
                    </div>
                    <span class="match-status-text ${statusTextColor}">${statusText}</span>
                </div>
            `;
            gridContainer.innerHTML += cardHtml;

            if (!isMatch) {
                nonMatchDimensions.push(`${dim.type} (${dim.name})`);
            }
        });

        renderPersuadeButtons(nonMatchDimensions);
        lucide.createIcons();
    }

    // --------------------------------------------------
    // 2. 설득 대상 버튼 렌더링 함수
    // --------------------------------------------------
    function renderPersuadeButtons(nonMatchDimensions) {
        const persuadeTargetContainer = document.querySelector('#persuade-section .flex.flex-wrap.gap-3');
        const persuadeSection = document.getElementById('persuade-section');
        persuadeTargetContainer.innerHTML = '';

        if (nonMatchDimensions.length > 0) {
            nonMatchDimensions.forEach(dimText => {
                // 이미지처럼 진한 오렌지 배경의 버튼
                const buttonHtml = `
                    <button type="button" class="persuade-target-button">
                        ${dimText}
                    </button>
                `;
                persuadeTargetContainer.innerHTML += buttonHtml;
            });
            // 불일치하는 부분이 있을 경우에만 섹션 표시
            persuadeSection.style.display = 'block';

        } else {
            // 일치할 경우 섹션 숨김 (이전 요청 사항)
            persuadeSection.style.display = 'none';
        }
    }

    // --------------------------------------------------
    // 3. 바 차트 렌더링 함수 (기존 로직 유지)
    // --------------------------------------------------
    function renderBarCharts() {
        const barContainer = document.getElementById('bar-charts-container');
        barContainer.innerHTML = '';

        const chartData = [
            { type: "에너지의 방향성", left: 'E', right: 'I', valLeft: parseInt(hiddenValueE.value), valRight: parseInt(hiddenValueI.value), labelLeft: '외향', labelRight: '내향' },
            { type: "인식 기능", left: 'S', right: 'N', valLeft: parseInt(hiddenValueS.value), valRight: parseInt(hiddenValueN.value), labelLeft: '감각', labelRight: '직관' },
            { type: "판단 기능", left: 'T', right: 'F', valLeft: parseInt(hiddenValueT.value), valRight: parseInt(hiddenValueF.value), labelLeft: '사고', labelRight: '감정' },
            { type: "생활 양식", left: 'J', right: 'P', valLeft: parseInt(hiddenValueJ.value), valRight: parseInt(hiddenValueP.value), labelLeft: '판단', labelRight: '인식' }
        ];

        chartData.forEach(data => {
            const total = data.valLeft + data.valRight;

            if (total === 0) return;

            const percentLeft = Math.round((data.valLeft / total) * 100);
            const percentRight = 100 - percentLeft;

            const colorLeft = (percentLeft > percentRight) ? 'var(--blue-main)' : '#e5e7eb';
            const colorRight = (percentRight > percentLeft) ? 'var(--blue-main)' : '#e5e7eb';

            const textLeftColor = (percentLeft > percentRight) ? 'white' : '#1f2937';
            const textRightColor = (percentRight > percentLeft) ? 'white' : '#1f2937';

            const itemHtml = `
                <div class="bar-chart-item">
                    <div class="flex justify-between text-base font-semibold mb-1 text-gray-800">
                        <span class="flex items-center gap-1">
                            <span class="bar-icon">${data.left}</span> ${data.labelLeft}
                        </span>
                        <span>
                            ${data.type}
                        </span>
                        <span class="flex items-center gap-1 text-right">
                            ${data.labelRight} <span class="bar-icon">${data.right}</span>
                        </span>
                    </div>
                    <div class="bar-container-new">
                        <div class="bar-segment-left" style="width: ${percentLeft}%; background-color: ${colorLeft};"></div>
                        <div class="bar-segment-right" style="width: ${percentRight}%; background-color: ${colorRight};"></div>
                        <div class="bar-label-overlay">
                            <span style="width: ${percentLeft}%; text-align: right; padding-right: 0.5rem; color: ${textLeftColor};">${percentLeft}%</span>
                            <span style="width: ${percentRight}%; text-align: left; padding-left: 0.5rem; color: ${textRightColor};">${percentRight}%</span>
                        </div>
                    </div>
                </div>
            `;
            barContainer.innerHTML += itemHtml;
        });
    }

    // --------------------------------------------------
    // 4. 설득 대결 시작하기 버튼 클릭 이벤트 (기존 로직 유지)
    // --------------------------------------------------
    const persuadeButton = document.getElementById('persuade-button');
    const form = document.getElementById('persuade-form');

    persuadeButton.addEventListener('click', () => {

        // 폼 필드에 값 채워넣기 (POST 전송 준비)
        document.getElementById('formTitle').value = hiddenTitle.value;
        document.getElementById('formCharacterName').value = hiddenCharacterName.value;
        document.getElementById('formCategory').value = hiddenCategory.value;
        document.getElementById('formAiThing').value = document.getElementById('hiddenAiThing') ? document.getElementById('hiddenAiThing').value : '';
        document.getElementById('formFullMbti').value = hiddenUserFullMbti.value;

        document.getElementById('formValueE').value = hiddenValueE.value;
        document.getElementById('formValueI').value = hiddenValueI.value;
        document.getElementById('formValueS').value = hiddenValueS.value;
        document.getElementById('formValueN').value = hiddenValueN.value;
        document.getElementById('formValueT').value = hiddenValueT.value;
        document.getElementById('formValueF').value = hiddenValueF.value;
        document.getElementById('formValueJ').value = hiddenValueJ.value;
        document.getElementById('formValueP').value = hiddenValueP.value;

        document.getElementById('formEi').value = hiddenUserEi.value;
        document.getElementById('formSn').value = hiddenUserSn.value;
        document.getElementById('formTf').value = hiddenUserTf.value;
        document.getElementById('formJp').value = hiddenUserJp.value;

        form.submit();
    });

    // --------------------------------------------------
    // 5. 페이지 로드 시 초기화 및 렌더링 호출
    // --------------------------------------------------

    // 전체 일치 메시지 컨테이너 렌더링
    const mbtiMessageContainer = document.getElementById('mbti-message-container');

    if (isMbtiMatch) {
        mbtiMessageContainer.innerHTML = `<div class="bg-green-50 border border-green-200 rounded-xl p-4 flex items-start gap-3"><div class="flex-shrink-0"><i data-lucide="check-circle" class="w-6 h-6 text-green-500"></i></div><p class="text-sm text-green-800 flex-1 leading-relaxed"><span class="font-semibold">분석이 일치합니다!</span> 당신이 예측한 MBTI와 AI의 분석 결과가 완벽하게 일치했습니다.</p></div>`;
    } else {
        mbtiMessageContainer.innerHTML = `<div class="bg-orange-50 border border-orange-200 rounded-xl p-4 flex items-start gap-3"><div class="flex-shrink-0"><i data-lucide="alert-triangle" class="w-6 h-6 text-orange-500"></i></div><p class="text-sm text-orange-800 flex-1 leading-relaxed"><span class="font-semibold">분석 차이가 발견되었습니다.</span> AI와 당신의 예측 사이에 불일치가 있습니다. 작품의 근거와 논리를 활용하여 AI를 설득해주세요!</p></div>`;
    }

    // 바 차트 렌더링 함수 실행
    renderBarCharts();

    // 개별 지표 카드 렌더링 함수 실행
    renderDimensionCards();

    // 동적 삽입된 아이콘 재렌더링
    lucide.createIcons();

</script>
</body>
</html>